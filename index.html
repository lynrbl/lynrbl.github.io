<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>mytitle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="top-bar">
        <div>Application de démonstration Bluetooth</div>
        <button class="footer-btn" onclick="init()">Connexion</button>
    </div>

    <div id="status">None</div>

    <div id="player-buttons">
        <button class="player-btn red" onclick="sendCmd('rouge')">Joueur 1</button>
        <button class="player-btn blue" onclick="sendCmd('bleu')">Joueur 2</button>
    </div>

    <div class="footer">
        <button class="footer-btn" onclick="sendCmd('reset')">Recommencer</button>
    </div>

    <script>
        var rx = null;
        var tx = null;
        const serviceUuid = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        let device = null;

        async function init() {
            if (!('bluetooth' in navigator)) {
                alert("Support bluetooth non disponible, veuillez activer le mode expérimental")
                return;
            }

            device = await navigator.bluetooth.requestDevice({ filters: [{ services: [serviceUuid] }] });
            document.getElementById("status").innerText = `device.name=${device.name}`;
            console.log(`device.name=${device.name}`);
            connect();
        }

        async function connect() {
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(serviceUuid);
            tx = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
            rx = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

            await rx.startNotifications();
            rx.addEventListener('characteristicvaluechanged', event => {
                const receivedValue = event.target.value;
                const message = new TextDecoder().decode(receivedValue);
                console.log('Received message:', message);
                document.getElementById("status").innerText = message;
            });

            document.getElementById("status").innerText = "Connexion RX/TX effectuée";
        }

        async function sendCmd(cmd) {
            const encoder = new TextEncoder();
            document.getElementById("status").innerText = `commande à envoyer: ${cmd}`;
            const cmdBytes = encoder.encode(cmd);
            await tx.writeValue(cmdBytes);
        }
    </script>
</body>

</html>